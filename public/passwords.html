<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <script src="../assets/js/jquery3.3.1.js"></script>
  <title>PWM-List</title>
</head>

<body onload="pageLoad()">
  <h1>Password Manager</h1>

  <form>
    <p>Site/Service: <input type="text" id="new-site"></p>
    <p>User Name: <input type="text" id="new-user-name"></p>
    <p>Password: <input type="text" id="new-password"><button id="generate-pw">GeneratePW</button></p>
    <button onclick="newPassword()">New Entry</button>
  </form>

  <form>
    <table id="password-list">
      <tr id="table-head">
        <th>
          <p>Site/Service</p>
        </th>
        <th>
          <p>User Name</p>
        </th>
        <th>
          <p>Password</p>
        </th>
        <th>
          <p>Options</p>
        </th>
      </tr>
    </table>
  </form>

  <footer>
    <script src="assets/js/links.js"></script>
  </footer>

  <script src="assets/js/storage.js"></script>
  <script src="assets/js/password-generator.js"></script>
  <script src="assets/js/md5-js.js"></script>
  <script src="assets/js/md5.js"></script>
  <script src="assets/js/sh1.js"></script>
  <script src="assets/js/sha256.js"></script>
  <script src="assets/js/sha512.js"></script>
  <script src="assets/js/aes-js.js"></script>
  <script src="assets/js/main.js"></script>
  <script>
    const server = window.location.href.replace("?", "").replace("passwords.html", "");
    let listPW = []

    function getPasswordsList() {
      // event.preventDefault();
      const URL = server + 'api/users';
      let localStore = JSON.parse(localStorage.getItem('PWM'))
      $.ajax({
        type: 'POST',
        url: URL,
        dataType: 'json',
        headers: {
          'authorization': 'Bearer ' + JSON.stringify(localStore.jwt)
        },
        data: {
            username: localStore.user,
          }
      }).done(function (data) {
        listPW = JSON.parse(data);
      })
    };

    function populateList() {
      // console.log(listPW.length)
      for(let i = 0; i < listPW.length; i++){
        
        generateList(i);
      }
    };

    function generateList(i) {
      // let userName = JSON.parse(localStorage.getItem('PWM')).user

      let passForm = document.getElementById('password-list');
      let newRow = document.createElement('tr');
      newRow.id = `${listPW[i].site}-row`
      passForm.appendChild(newRow)

      let row = document.getElementById(`${listPW[i].site}-row`);
      let newInputData = document.createElement('td');
      newInputData.id = `${listPW[i].site}-site`
      row.appendChild(newInputData)

      let inputData = document.getElementById(`${listPW[i].site}-site`)
      let siteInput = document.createElement('input')
      siteInput.id = `${listPW[i].site}-site-input`
      siteInput.type = 'text'
      siteInput.value = listPW[i].site
      inputData.appendChild(siteInput)

      let newInputUserName = document.createElement('td');
      newInputUserName.id = `${listPW[i].site}-userName`
      row.appendChild(newInputUserName)

      let userNameInput = document.createElement('input')
      userNameInput.id = `${listPW[i].site}-userName-input`
      userNameInput.type = 'text'
      userNameInput.value = listPW[i].username
      newInputUserName.appendChild(userNameInput)

      let newInputPassword = document.createElement('td');
      newInputPassword.id = `${listPW[i].site}-password`
      row.appendChild(newInputPassword)

      let passwordInput = document.createElement('input')
      passwordInput.id = `${listPW[i].site}-password-input`
      passwordInput.type = 'text'
      passwordInput.value = listPW[i].password
      newInputPassword.appendChild(passwordInput)

      let newOptions = document.createElement('td');
      newOptions.id = `${listPW[i].site}-options`
      row.appendChild(newOptions)

      let buttonShow = document.createElement('button')
      buttonShow.id = `${listPW[i].site}-button-show`
      buttonShow.innerHTML = "Show-PW"
      buttonShow.setAttribute("onclick", "showPassword(" + i + ")");
      newOptions.appendChild(buttonShow);

      let buttonNew = document.createElement('button')
      buttonNew.id = `${listPW[i].site}-button-new`
      buttonNew.innerHTML = "New-PW"
      buttonNew.setAttribute("onclick", "newPassword(" + i + ")");
      newOptions.appendChild(buttonNew);

      let buttonUpdate = document.createElement('button')
      buttonUpdate.id = `${listPW[i].site}-button-update`
      buttonUpdate.innerHTML = "Update"
      buttonUpdate.setAttribute("onclick", "updateInfo(" + i + ")");
      newOptions.appendChild(buttonUpdate);

      let buttonDelete = document.createElement('button')
      buttonDelete.id = `${listPW[i].site}-button-delete`
      buttonDelete.innerHTML = "Delete"
      buttonDelete.setAttribute("onclick", "deleteRow(" + i + ")");
      newOptions.appendChild(buttonDelete);
    }

    function newPassword(){
      event.preventDefault();
      console.log('Generating new password for')
      let siteService = document.getElementById('new-site').value;
      let userName = document.getElementById('new-user-name').value;
      let password = document.getElementById('new-password').value;
      let newEntry = {
        site : siteService,
        username : userName,
        password : password
      }
      console.log("sending:", newEntry)
      const URL = server + 'api/users/add';
      let localStore = JSON.parse(localStorage.getItem('PWM'))
      $.ajax({
        type: 'POST',
        url: URL,
        dataType: 'json',
        headers: {
          'authorization': 'Bearer ' + JSON.stringify(localStore.jwt)
        },
        data: {
          username: localStore.user,
          entry: JSON.stringify(newEntry)
        }
      }).done(function (status) {
        if (status.status === "success") {
          console.log('add successfull');
          listPW.push(newEntry);
          generateList(listPW.length -1)
          // document.getElementById("message").innerHTML = "User Removal Successfull";
          // document.getElementById("message").style.color = "green";
        } else {
          // document.getElementById("message").innerHTML = "User Removal Failed";
          // document.getElementById("message").style.color = "red";
        }
      })
    }

    function showPassword(i){
      event.preventDefault();
      console.log('Showing password for', listPW[i].site)
    }

    function updateInfo(i){
      event.preventDefault();
      console.log('Updating info for', listPW[i].site)
    }

    function deleteRow(i){
      event.preventDefault();
      console.log('deleting row for for', listPW[i].site) 
    }

    function pageLoad() {
      getPasswordsList()
      setTimeout(function () {
        populateList();
      }, 3000);
    }
  </script>
</body>

</html>